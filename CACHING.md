# 缓存策略文档

## 📦 缓存架构

本项目采用多层缓存策略，结合按需加载，最大化减少网络请求，提升用户体验。

### 缓存层次

```
用户操作
   ↓
内存缓存 (Pinia Store + Map)
   ↓
本地缓存 (localStorage + IndexedDB)
   ↓
同步队列 (Sync Queue)
   ↓
远程数据库 (Supabase)
```

### 词典数据缓存

```
查看单词
   ↓
内存缓存 (Map) → 有 → 立即返回 (<1ms)
   ↓ 无
IndexedDB → 有 → 返回 (<10ms)
   ↓ 无
HTTP 请求 → 缓存 → 返回 (~100ms)
```

## 🎯 核心优化策略

### 1. 乐观更新 (Optimistic Updates)

用户操作立即反映在 UI 上，无需等待服务器响应：

```javascript
// 用户点击收藏
addCollection(word) → 立即更新UI → 后台同步到服务器
```

**优点**：
- ⚡ 即时响应，无延迟感
- 🔄 失败时可回滚
- 📱 支持离线操作

### 2. 本地优先 (Local First)

数据优先从本地缓存读取：

```javascript
loadCollections() {
  1. 从 localStorage 加载 → 立即显示
  2. 后台从服务器同步 → 更新缓存
  3. 定期同步（5分钟）
}
```

**优点**：
- 🚀 快速加载
- 💾 减少网络请求
- 📶 离线可用

### 3. 智能同步队列

失败的操作会保存到队列，自动重试：

```javascript
操作失败 → 加入同步队列 → 定期重试 → 成功后移除
```

**触发时机**：
- ⏰ 每 5 分钟自动同步
- 👁️ 用户切回标签页时
- 🌐 网络恢复时
- 🔄 手动触发

## 📊 缓存的数据类型

### 词典索引 (Dictionary Index)

- **存储位置**: HTTP 缓存 + 内存
- **大小**: ~3.4 MB
- **更新策略**: 构建时生成，版本控制
- **用途**: 搜索和单词列表

### 单词详情 (Word Details)

- **存储位置**: 内存 (Map) + IndexedDB
- **大小**: 2-5 KB / 单词
- **更新策略**: 按需加载，永久缓存
- **容量限制**: 内存最多 200 个，IndexedDB 无限制

### 用户收藏 (Collections)

- **缓存键**: `dict_v1_{userId}_collections`
- **过期时间**: 1 小时
- **更新策略**: 乐观更新 + 后台同步

### 学习进度 (Progress)

- **缓存键**: `dict_v1_{userId}_progress`
- **过期时间**: 1 小时
- **更新策略**: 乐观更新 + 后台同步

### 同步队列 (Sync Queue)

- **缓存键**: `dict_v1_sync_queue`
- **过期时间**: 永久（直到同步成功）
- **清理策略**: 同步成功后自动移除

## 🔄 数据流程

### 添加收藏流程

```
用户点击收藏
    ↓
1. 立即更新内存 (collectionList)
2. 保存到 localStorage
3. 添加到同步队列
    ↓
后台同步
    ↓
4. 尝试同步到 Supabase
5. 成功：从队列移除
6. 失败：保留在队列，下次重试
```

### 学习进度更新流程

```
用户标记单词
    ↓
1. 计算新的复习参数 (SM-2)
2. 立即更新内存 (progressList)
3. 重新计算统计数据
4. 保存到 localStorage
5. 添加到同步队列
    ↓
后台同步
    ↓
6. 批量同步到 Supabase
7. 更新缓存时间戳
```

## 💾 存储容量

### 词典数据存储

| 存储类型 | 内容 | 大小 | 说明 |
|---------|------|------|------|
| HTTP 缓存 | 索引文件 | 3.4 MB | 首次加载，永久缓存 |
| 内存缓存 | 单词详情 | 200 个 × 3KB | 运行时快速访问 |
| IndexedDB | 单词详情 | 无限制 | 已查看单词永久存储 |

### 用户数据存储 (localStorage)

| 数据类型 | 平均大小 | 1000词 | 10000词 |
|---------|---------|--------|---------|
| 收藏列表 | ~50B/词 | 50KB | 500KB |
| 学习进度 | ~200B/词 | 200KB | 2MB |
| 同步队列 | ~150B/项 | 变动 | 变动 |
| **总计** | - | ~250KB | ~2.5MB |

> 存储限制：localStorage 5-10MB，IndexedDB 通常 50MB+，足够使用

## 🔧 缓存管理 API

### 手动同步

```javascript
import { useLearningStore } from '@/stores/learning'

const learningStore = useLearningStore()

// 手动触发同步
await learningStore.syncWithServer()
```

### 清除缓存

```javascript
// 清除当前用户缓存
learningStore.clearUserData()

// 清除所有用户缓存
import { clearAllUserCache } from '@/utils/cache'
clearAllUserCache(userId)
```

### 查看同步队列

```javascript
import { getSyncQueue } from '@/utils/cache'

const queue = getSyncQueue()
console.log('待同步项:', queue.length)
```

## 📱 离线支持

### 离线功能

✅ **完全支持**：
- 浏览词典
- 学习新单词
- 标记学习进度
- 添加/移除收藏

⚠️ **部分支持**：
- 复习页面（需先加载一次）
- 统计数据（本地计算）

❌ **不支持**：
- 用户注册/登录
- 跨设备同步（恢复在线后自动同步）

### 离线检测

系统会自动检测网络状态，并显示提示：

- 📡 **离线模式**：黄色横幅提示
- 🔄 **正在同步**：蓝色横幅提示

## 🐛 故障处理

### 缓存损坏

如果缓存数据损坏：

1. 系统自动忽略无效缓存
2. 从服务器重新加载
3. 重建本地缓存

### 同步冲突

本地和服务器数据不一致时：

- **策略**：服务器数据优先
- **原因**：确保跨设备数据一致性
- **影响**：本地未同步的操作可能丢失

**建议**：
- 保持网络连接
- 定期查看同步状态
- 重要操作后等待同步完成

## 🔐 安全考虑

### 数据加密

- ❌ localStorage 中的数据**未加密**
- ⚠️ 不存储敏感信息（仅存储单词和进度）
- ✅ 认证令牌由 Supabase SDK 自动管理

### 数据隔离

- ✅ 每个用户的数据独立存储
- ✅ 用户 ID 作为缓存键的一部分
- ✅ 登出时不清除缓存（下次登录可用）

## 📈 性能指标

### 请求减少

| 操作 | 无缓存 | 有缓存 | 优化率 |
|-----|--------|--------|--------|
| 加载收藏 | 1 次 | 0 次* | 100% |
| 添加收藏 | 1 次 | 0 次* | 100% |
| 学习 10 词 | 20 次 | 0 次* | 100% |
| 复习 10 词 | 22 次 | 0 次* | 100% |

> \* 后台异步同步，不阻塞用户操作

### 加载速度

| 操作 | 无缓存 | 有缓存 | 提升 |
|-----|--------|--------|------|
| 首次加载 | ~500ms | ~50ms | 10x |
| 后续加载 | ~300ms | <10ms | 30x |

## 🚀 最佳实践

### 开发者

1. **使用乐观更新**：立即更新 UI
2. **添加加载状态**：显示同步进度
3. **处理错误**：友好的错误提示
4. **测试离线**：模拟离线场景

### 用户

1. **保持联网**：确保数据同步
2. **查看状态**：注意同步提示
3. **定期登录**：防止缓存过期
4. **跨设备使用**：每台设备单独缓存

## 🔄 版本升级

缓存版本：`v1`

升级策略：
1. 更改 `CACHE_VERSION` 常量
2. 旧版本缓存自动失效
3. 从服务器重新加载数据

---

💡 **提示**：缓存极大提升了性能，但也要注意数据一致性。重要操作后请确保网络连接正常。

